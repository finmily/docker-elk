input {
	tcp {
		port => 5000
	}
	beats {
        port => 5044
        type => beats
    }
  redis {
    	host => "10.24.247.91"
    	data_type => "list"
    	key => "filebeat"
    	codec => "json"
    	# batch_count => 1
    	# threads => 1
  }
}

## Add your filters / logstash plugins configuration here

filter {
	if [type] in ["nginx-access","prod-nginx-access"] {
   	grok {
      patterns_dir => "/usr/local/logstash/patterns"
   	  match => {
        "message" => ["%{NGINXACCESS}"]
      }
      remove_field => "message"
   	}
   	mutate {
      convert => ["response", "integer"]
      convert => ["bytes", "integer"]
      convert => ["responsetime", "float"]
    }
    geoip {
      source => "clientip"
      target => "geoip"
      add_field => [ "[geoip][coordinates]", "%{[geoip][longitude]}" ]
      add_field => [ "[geoip][coordinates]", "%{[geoip][latitude]}"  ]
      add_tag => [ "nginx-geoip" ]
    }
    date {
      match => [ "timestamp" , "dd/MMM/YYYY:HH:mm:ss Z" ]
      remove_field => [ "timestamp" ]
    }
    useragent {
      source => "agent"
    }
  }

  if [type] == "prod-nginx-access" {
    grok {
      patterns_dir => "/usr/local/logstash/patterns"
      match => {
        "message" => ["%{NGINXACCESS}"]
      }
      remove_field => "message"
    }
    mutate {
      convert => ["response", "integer"]
      convert => ["bytes", "integer"]
      convert => ["responsetime", "float"]
    }
    geoip {
      source => "clientip"
      target => "geoip"
      add_field => [ "[geoip][coordinates]", "%{[geoip][longitude]}" ]
      add_field => [ "[geoip][coordinates]", "%{[geoip][latitude]}"  ]
      add_tag => [ "nginx-geoip" ]
    }
    date {
      match => [ "timestamp" , "dd/MMM/YYYY:HH:mm:ss Z" ]
      remove_field => [ "timestamp" ]
    }
    useragent {
      source => "agent"
    }
  }

  if [type] in ["yapp-app-log","yactivity-app-log","yconsole-app-log","ypc-app-log","ymsg-app-log","prod-yapp-app-log","prod-yactivity-app-log","prod-yconsole-app-log","prod-ypc-app-log","prod-ymsg-app-log"]  {
    grok {
      patterns_dir => "/usr/local/logstash/patterns"
      match => {
        "message" => ["%{NODEAPPLOG}"]
      }
      remove_field => "message"
    }
    date {
      match => [ "timestamp" , "dd/MMM/YYYY:HH:mm:ss Z" ]
      remove_field => [ "timestamp" ]
    }
  }

  if [type] in ["prod-yapp-access-log","prod-yconsole-access-log","prod-yactivity-access-log","prod-ypc-access-log","prod-ymsg-access-log","yapp-access-log","yconsole-access-log","yactivity-access-log","ypc-access-log","ymsg-access-log"] {
    grok {
      patterns_dir => "/usr/local/logstash/patterns"
      match => {
        "message" => ["%{NODEACCESSLOG}"]
      }
      remove_field => "message"
    }
    mutate {
      convert => ["response", "integer"]
      convert => ["bytes", "integer"]
      convert => ["responsetime", "float"]
    }
    geoip {
      source => "clientip"
      target => "geoip"
      add_field => [ "[geoip][coordinates]", "%{[geoip][longitude]}" ]
      add_field => [ "[geoip][coordinates]", "%{[geoip][latitude]}"  ]
      add_tag => [ "node-geoip" ]
    }
    date {
      match => [ "timestamp" , "dd/MMM/YYYY:HH:mm:ss Z" ]
      remove_field => [ "timestamp" ]
    }
    useragent {
      source => "agent"
    }
  }


}

output {
  if [type] == "nginx-access" {
    elasticsearch {
            hosts => ["elasticsearch:9200"]
            manage_template => true
            index => "logstash-nginx-access-%{+YYYY-MM-DD}"
    }
  }

  if [type] == "prod-nginx-access" {
    elasticsearch {
            hosts => ["elasticsearch:9200"]
            manage_template => true
            index => "logstash-prod-nginx-access-%{+YYYY-MM-DD}"
    }
  }

  if [type] == "yapp-app-log" {
    elasticsearch {
            hosts => ["elasticsearch:9200"]
            manage_template => true
            index => "logstash-yapp-%{+YYYY-MM-DD}"
    }
  }
  if [type] == "yapp-access-log" {
    elasticsearch {
            hosts => ["elasticsearch:9200"]
            manage_template => true
            index => "logstash-yapp-access-%{+YYYY-MM-DD}"
    }
  }

  if [type] == "ypc-app-log" {
    elasticsearch {
            hosts => ["elasticsearch:9200"]
            manage_template => true
            index => "logstash-ypc-%{+YYYY-MM-DD}"
    }
  }
  if [type] == "ypc-access-log" {
    elasticsearch {
            hosts => ["elasticsearch:9200"]
            manage_template => true
            index => "logstash-ypc-access-%{+YYYY-MM-DD}"
    }
  }

  if [type] == "yconsole-app-log" {
    elasticsearch {
            hosts => ["elasticsearch:9200"]
            manage_template => true
            index => "logstash-yconsole-%{+YYYY-MM-DD}"
    }
  }
  if [type] == "yconsole-access-log" {
    elasticsearch {
            hosts => ["elasticsearch:9200"]
            manage_template => true
            index => "logstash-yconsole-access-%{+YYYY-MM-DD}"
    }
  }

  if [type] == "yactivity-app-log" {
    elasticsearch {
            hosts => ["elasticsearch:9200"]
            manage_template => true
            index => "logstash-yactivity-%{+YYYY-MM-DD}"
    }
  }
  if [type] == "yactivity-access-log" {
    elasticsearch {
            hosts => ["elasticsearch:9200"]
            manage_template => true
            index => "logstash-yactivity-access-%{+YYYY-MM-DD}"
    }
  }
  if [type] == "yapp-app-log" {
    elasticsearch {
            hosts => ["elasticsearch:9200"]
            manage_template => true
            index => "logstash-yapp-%{+YYYY-MM-DD}"
    }
  }
  if [type] == "yapp-access-log" {
    elasticsearch {
            hosts => ["elasticsearch:9200"]
            manage_template => true
            index => "logstash-yapp-access-%{+YYYY-MM-DD}"
    }
  }

  if [type] == "prod-yapp-app-log" {
    elasticsearch {
            hosts => ["elasticsearch:9200"]
            manage_template => true
            index => "logstash-prod-yapp-%{+YYYY-MM-DD}"
    }
  }
  if [type] == "prod-yapp-access-log" {
    elasticsearch {
            hosts => ["elasticsearch:9200"]
            manage_template => true
            index => "logstash-prod-yapp-access-%{+YYYY-MM-DD}"
    }
  }

  if [type] == "prod-ypc-app-log" {
    elasticsearch {
            hosts => ["elasticsearch:9200"]
            manage_template => true
            index => "logstash-prod-ypc-%{+YYYY-MM-DD}"
    }
  }
  if [type] == "prod-ypc-access-log" {
    elasticsearch {
            hosts => ["elasticsearch:9200"]
            manage_template => true
            index => "logstash-prod-ypc-access-%{+YYYY-MM-DD}"
    }
  }

  if [type] == "prod-yactivity-app-log" {
    elasticsearch {
            hosts => ["elasticsearch:9200"]
            manage_template => true
            index => "logstash-prod-yactivity-%{+YYYY-MM-DD}"
    }
  }
  if [type] == "prod-yactivity-access-log" {
    elasticsearch {
            hosts => ["elasticsearch:9200"]
            manage_template => true
            index => "logstash-prod-yactivity-access-%{+YYYY-MM-DD}"
    }
  }

  if [type] == "prod-yconsole-app-log" {
    elasticsearch {
            hosts => ["elasticsearch:9200"]
            manage_template => true
            index => "logstash-prod-yconsole-%{+YYYY-MM-DD}"
    }
  }
  if [type] == "prod-yconsole-access-log" {
    elasticsearch {
            hosts => ["elasticsearch:9200"]
            manage_template => true
            index => "logstash-prod-yconsole-access-%{+YYYY-MM-DD}"
    }
  }

  if [type] == "prod-ymsg-app-log" {
    elasticsearch {
            hosts => ["elasticsearch:9200"]
            manage_template => true
            index => "logstash-prod-ymsg-%{+YYYY-MM-DD}"
    }
  }
  if [type] == "prod-ymsg-access-log" {
    elasticsearch {
            hosts => ["elasticsearch:9200"]
            manage_template => true
            index => "logstash-prod-ymsg-access-%{+YYYY-MM-DD}"
    }
  }

  if [type] == "yeaservice-log" {
    elasticsearch {
            hosts => ["elasticsearch:9200"]
            manage_template => true
            index => "logstash-yea-service-%{+YYYY-MM-DD}"
    }
  }

  if [type] == "yeacore-log" {
  elasticsearch {
      hosts => ["elasticsearch:9200"]
      manage_template => true
      index => "logstash-yea-core-%{+YYYY-MM-DD}"
    }
  }

  if [type] == "yeaconsole-log" {
  elasticsearch {
      hosts => ["elasticsearch:9200"]
      manage_template => true
      index => "logstash-yea-console-%{+YYYY-MM-DD}"
    }
  }


  if [type] == "prod-yeaconsole-app-log" {
    elasticsearch {
            hosts => ["elasticsearch:9200"]
            manage_template => true
            index => "logstash-prod-yea-console-%{+YYYY-MM-DD}"
    }
  }


  if [type] == "prod-yeaservice-app-log" {
    elasticsearch {
            hosts => ["elasticsearch:9200"]
            manage_template => true
            index => "logstash-prod-yea-service-%{+YYYY-MM-DD}"
    }
  }

  if [type] == "prod-yeacore-app-log" {
    elasticsearch {
            hosts => ["elasticsearch:9200"]
            manage_template => true
            index => "logstash-prod-yea-core-%{+YYYY-MM-DD}"
    }
  }


  if [type] == "prod-yeamsg-app-log" {
    elasticsearch {
            hosts => ["elasticsearch:9200"]
            manage_template => true
            index => "logstash-prod-yea-msg-%{+YYYY-MM-DD}"
    }
  }
}
